_format_version: "3.0"
_transform: true


services:
# ───────────── file-service ───────────────────────────────────────────────────
- name: file-service
  url: http://file-service:8001

  routes:
  - name: upload-route
    paths: [ /upload ]
    methods: [ POST ]
    strip_path: false

  - name: file-health
    paths: [ /health ]
    methods: [ GET ]
    strip_path: false

  plugins:
  - name: openid-connect
    config:
      issuer: http://auth-service:8005
      discovery: true
      verify_signature: true
      verify_claims: true
      scopes_required: []
      roles_claim: "scope"
      consumer_claim: "sub"
  - name: rate-limiting
    config:
      second: 5
      minute: 100
      policy: local
  - name: cors
    config:
      origins: "*"
      methods: [ GET, POST ]
      headers: [ Authorization, Content-Type ]
      exposed_headers: [ X-User-ID ]
      credentials: true
      max_age: 3600
  - name: request-transformer
    config:
      add:
        headers:
        - "X-User-ID:$(jwt.claim.sub)"

# ────────── processing-service ────────────────────────────────────────────────
- name: processing-service
  url: http://processing-service:8003

  routes:
  - name: result-route
    paths: [ /result ]
    methods: [ GET ]
    strip_path: false

  plugins:
  - name: openid-connect
    config:
      issuer: http://auth-service:8005
      discovery: true
      verify_signature: true
      verify_claims: true
      scopes_required: []
      roles_claim: "scope"
      consumer_claim: "sub"
  - name: rate-limiting
    config:
      second: 5
      minute: 100
      policy: local
  - name: cors
    config:
      origins: "*"
      methods: [ GET, POST ]
      headers: [ Authorization, Content-Type ]
      exposed_headers: [ X-User-ID ]
      credentials: true
      max_age: 3600
  - name: request-transformer
    config:
      add:
        headers:
        - "X-User-ID:$(jwt.claim.sub)"